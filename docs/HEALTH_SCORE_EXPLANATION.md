# Financial Health Score - Техническое описание

## Общая формула

Health Score вычисляется как взвешенная сумма четырех компонентов. Каждый компонент имеет свой вес и нормализуется к диапазону 0-100 баллов.

## Компоненты и веса

1. Savings Rate (30%) - процент накоплений от дохода
2. Emergency Fund (25%) - размер финансовой подушки в месяцах
3. Spending Stability (25%) - стабильность расходов
4. Essential Ratio (20%) - баланс обязательных и необязательных расходов

## Расчет компонентов

### 1. Savings Rate

**Что измеряет:** Сколько процентов дохода остается после всех расходов.

**Расчет:** Вычитаем расходы из дохода, делим на доход и умножаем на 100. Например, при доходе 50000 и расходах 30000 получаем (50000 - 30000) / 50000 × 100 = 40%.

**Нормализация:** Используется сигмоидальная функция для плавного перехода. При 0% накоплений получаем 0 баллов. При 20% и выше получаем почти 100 баллов. Между этими значениями переход плавный, без резких скачков. Центр функции находится на 15% - это точка, где функция начинает быстро расти.

**Параметры:** Крутизна функции 0.3, центр на 15%. Это означает, что при 15% накоплений функция дает примерно 50 баллов, а при 20% уже близко к 100.

### 2. Emergency Fund

**Что измеряет:** На сколько месяцев хватит текущих накоплений при среднем уровне расходов.

**Расчет:** Делим общий баланс на средние месячные расходы. Например, при балансе 180000 и средних расходах 30000 получаем 6 месяцев.

**Нормализация:** Используется комбинированный подход. Для первых трех месяцев применяется линейная шкала: 0 месяцев дает 0 баллов, 3 месяца дают 50 баллов. Для диапазона 3-6 месяцев используется логарифмическая шкала, которая учитывает, что каждый дополнительный месяц становится менее критичным. При 6 месяцах и выше получаем максимум 100 баллов.

**Логика:** Система признает, что первые 3 месяца критичны, поэтому рост линейный. После 3 месяцев каждый дополнительный месяц менее важен, поэтому используется логарифм для плавного перехода к максимуму.

### 3. Spending Stability

**Что измеряет:** Насколько стабильны расходы месяц к месяцу. Низкая вариация означает предсказуемость бюджета.

**Расчет коэффициента вариации:** Сначала вычисляем среднее значение расходов за 6 месяцев. Затем находим стандартное отклонение - меру разброса значений. Коэффициент вариации показывает, насколько расходы отклоняются от среднего в процентах. Низкий коэффициент означает стабильность.

**Детекция аномалий:** Используется Z-score для выявления выбросов. Если расходы в каком-то месяце отклоняются от среднего более чем на 2 стандартных отклонения, это считается аномалией. За каждую аномалию начисляется штраф до 30 баллов.

**Экспоненциальное взвешивание:** Более свежие месяцы получают больший вес при расчете. Это означает, что недавние расходы важнее старых. Коэффициент затухания 0.3 обеспечивает плавное снижение веса для более старых месяцев.

**Итоговый score:** Комбинируем базовый коэффициент вариации (60% веса) и взвешенный коэффициент вариации (40% веса), затем вычитаем штраф за аномалии. Низкий коэффициент вариации дает высокий балл, высокий коэффициент вариации снижает балл.

### 4. Essential Ratio

**Что измеряет:** Доля обязательных расходов от общих расходов. Оптимальное значение 50-60%.

**Расчет:** Делим сумму обязательных расходов на общие расходы и умножаем на 100. Например, при общих расходах 30000 и обязательных 18000 получаем 60%.

**Нормализация:** Используется гауссова функция с центром на 55%. Это означает, что при 55% обязательных расходов получаем максимум 100 баллов. При отклонении от 55% балл плавно снижается по нормальному распределению. Стандартное отклонение 10% означает, что диапазон 45-65% дает высокие баллы, а дальше от центра баллы быстро падают.

**Логика:** Система признает, что слишком мало обязательных расходов означает излишние траты на развлечения, а слишком много означает финансовую нагрузку. Оптимальный баланс около 55%.

## Прогнозирование тренда

### Линейная регрессия

**Модель:** Строим прямую линию через точки Health Score за последние 3-4 месяца. Линия описывается уравнением, где x - номер месяца, y - значение score.

**Коэффициенты:** Вычисляем наклон линии и точку пересечения с осью. Наклон показывает, растет ли score или падает. Положительный наклон означает улучшение, отрицательный - ухудшение.

**Прогноз:** Продолжаем линию на один месяц вперед. Это дает прогнозируемое значение score на следующий месяц.

**Уверенность:** Используется коэффициент детерминации R², который показывает, насколько хорошо линия описывает данные. Если данные лежат близко к линии, уверенность высокая (близко к 100%). Если данные разбросаны, уверенность низкая (близко к 0%).

**Направление:** Если наклон больше 2, тренд улучшающийся. Если наклон меньше -2, тренд ухудшающийся. Иначе тренд стабильный.

## Обработка граничных случаев

### Защита от деления на ноль

Перед каждым делением проверяем, что делитель не равен нулю. Если доход равен нулю, не вычисляем savings rate. Если средние расходы равны нулю, не вычисляем emergency fund. Если стандартное отклонение равно нулю, не вычисляем Z-score. Если сумма квадратов отклонений слишком мала, не вычисляем коэффициент детерминации.

### Недостаток данных

Если данных меньше чем за 2 месяца, для стабильности возвращаем средний балл 50.0. Если нет данных за 3 месяца, используем текущий месяц. Если нет данных для прогноза, устанавливаем уверенность в 0 и направление "стабильный".

### Ограничение диапазонов

Все баллы ограничены диапазоном от 0 до 100. Если вычисленное значение меньше 0, возвращаем 0. Если больше 100, возвращаем 100. Savings rate не может быть отрицательным. Emergency fund не может быть отрицательным. Essential ratio должен быть в диапазоне 0-100%.

## Адаптивные бенчмарки

**Расчет:** Анализируем историю пользователя за последние 6 месяцев. Вычисляем среднее значение для каждого показателя. Устанавливаем бенчмарк как среднее значение, умноженное на 1.1, но не ниже стандартных значений.

**Логика:** Система адаптируется под каждого пользователя. Если пользователь обычно откладывает 15%, цель устанавливается на 16.5%, а не на стандартные 20%. Это делает цели достижимыми и мотивирующими. Стандартные значения используются как минимум: 20% для savings rate, 6 месяцев для emergency fund.

## Генерация инсайтов

**Алгоритм:** Анализируем каждый компонент отдельно. Сравниваем текущее значение с пороговыми. Если значение ниже порога, генерируем предупреждение или возможность улучшения. Если значение выше порога, генерируем достижение.

**Пороговые значения:** Savings rate ниже 10% - предупреждение, выше 20% - достижение. Emergency fund ниже 3 месяцев - предупреждение, выше 6 месяцев - достижение. Stability ниже 50 - возможность улучшения. Essential ratio ниже 50% или выше 80% - предупреждение.

**Типы инсайтов:** Warning означает критическую проблему, требующую внимания. Opportunity означает возможность улучшения с указанием потенциального роста score. Achievement означает хороший показатель, который стоит поддерживать.

## Оценка (Grade)

Система присваивает буквенную оценку на основе числового score:
- A: 90-100 баллов
- B: 75-89 баллов
- C: 60-74 балла
- D: 40-59 баллов
- F: 0-39 баллов

## Сложность алгоритмов

**Временная сложность:** Расчет всех компонентов требует одного прохода по транзакциям, что дает O(n) где n - количество транзакций. Расчет стабильности требует обработки 6 месяцев, что является константой O(1). Регрессия работает с 3-4 точками, что также O(1). Общая сложность линейная O(n).

**Пространственная сложность:** Хранение временных рядов требует O(m) памяти где m - количество месяцев (обычно 6). Общая сложность O(m).
